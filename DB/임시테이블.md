내부 임시 테이블 활용

- MySQL엔진이 스토리지 엔진으로부터 받아온 레코드를 정렬하거나 그루핑할 때는 내부적인 임시 테이블을 사용한다.
- CREATE TEMPORARAY TABLE 명령으로 만든 임시 테이블과는 다르다.
- 임시 테이블은 일반적으로 처음에 메모리에 생성됐다가 테이블의 크기가 커지면 디스크로 옮겨짐.
    - 특정 예외 케이스들은 처음부터 디스크에 생성되기도 함.
- 임시 테이블은 다른 세션이나 다른 쿼리에서는 볼 수 없으며 사용하는 것도 불가능.
- 내부적인 임시 테이블은 쿼리의 처리가 완료되면 자동으로 삭제됨.


### 메모리 임시 테이블과 디스크 임시 테이블

**MySQL 8.0 이전 버전**
- 임시 테이블이 메모리를 사용할 때는 MEMORY 스토리지 엔진
    - VARBINARY, VARCHAR 같은 가변 길이 타입 지원 못함.
        - 최대 길이 만큼 메모리를 할당하여 사용하기 때문에 메모리 낭비 심함.
- 디스크에 저장될 때는 MyISAM 스토리지 엔진 이용
    - 트랜잭션 지원 못함.


**MySQL 8.0 이후 버전**
- 임시테이블이 메모리 사용할 때는 TempTable 스토리지 엔진 사용
    - 가변길이 타입 지원
    - internal_tmp_mem_storage_engine 시스템 변수 이용 메모리용 임시 테이블 선택 가능
        - MEMORY, TempTable 중 선택 가능 default 는 TempTable
    - TempTable이 사용할 메모리 공간의 크기를 temptable_max_ram 시스템 변수로 제어 가능
        - 기본은 1GB
- 임시 테이블의 크기가 1GB 보다 커지는 경우 임시 테이블을 디스크로 기록
    - MMAP 파일로 디스크에 기록
    - InnoDB 테이블로 기록
    - 어느 방법으로 기록할지는 temptable_use_mmap 시스템 변수로 설정 가능 Default는 1GB
    - 1GB 넘으면 TempTable을 MMAP 파일로 전환
- 디스크에 저장될 때는 InnoDB 스토리지 엔진 이용
    - 트랜잭션 지원

**처음부터 디스크 테이블로 생성되는 경우?**
- internal_tmp_disk_storage_engine 시스템 변수에 설정된 스토리지 엔진이 사용
- 기본값은 InnoDB


### 임시 테이블이 필요한 쿼리
MySQL 엔진에서 별도의 데이터 가공 작업을 필요로 하므로 대표적으로 내부 임시테이블을 생성하는 케이스
- ORDER BY와 GROUP BY에 명시된 컬럼이 다른 쿼리
- ORDER BY나 GROUP BY에 명시된 컬럼이 조인의 순서상 첫 번째 테이블이 아닌 쿼리
- DISTINCT와 ORDER BY가 동시에 쿼리에 존재하는 경우 또는 DISTINCT가 인덱스로 처리되지 못하는 쿼리
- UNION이나 UNION DISTINCT가 사용된 쿼리(select_type 컬럼이 UNION RESULT인 경우)
- 쿼리의 실행 계획에서 select_type이 DERIVED인 쿼리

**임시 테이블을 사용하는지 어떻게 확인할까?**
- 실행 게획은 Extra 컬럼에서 "Using temporary" 라는 메시자가 표시되는지 확인.
- "Using temporary" 메시지가 표시되지 않아도 임시 테이블을 사용하는 경우가 있다.
    - 위의 예시에서 마지막 3개 패턴이 그 예
- 마지막 쿼리 패턴은 유니크 인덱스가 없는 내부 임시 테이블이 생성
    - 유니크 인덱스가 있는 내부 임시 테이블은 그렇지 않은 쿼리보다 처리 성능이 상당히 느리다.