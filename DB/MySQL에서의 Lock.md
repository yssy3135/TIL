# Mysql에서의 Lock

Mysql에서 사용되는 잠금은 스토리지 레벨과 Mysql엔진 레벨로 나눌 수 있다.

- Mysql엔진 부분은 MySql서버에서 스토리지 영역을 제외한 나머지 모든 부분
- 엔진 영역은 모든 스토리지 엔진에 영향을 미침
- 스토리지 엔진 레벨 잠금은 스토리지 엔진간 상호 영향을 미치지는 않음.

### MySql Lock의 종류

- 테이블 락
    - 테이블 데이터 동기화를 위함.
- 메타데이터 락
    - 테이블 구조를 잠금
- 네임드 락
    - 사용자의 필요에 따라 알맞게 사용할 수 있다.

## 글로벌 락

- FLUSH TABLES WITH READLOCK 명령어로 사용
- MYSQL의 LOCK 중에서 가장 범위가 크다.
- SELECT를 제외한 모든 DML,DDL 문 락이 해제 될 때 까지 대기해야 함.
- 범위는 MYSQL 서버 전체, DB가 달라도 동일하게 적용됨.
- MY ISAM이나 MEMORY 테이블에대해 mysqldump로 일관된 백업을 받아야 할 때 사용
- InnoDB 스토리지 엔진은 트랜잭션을 지원하기 때문에 일관된 상태를 유지하기 위해서 글로벌 락을 사용하지 않아도 된다.

## 백업 락.

- MYSQL8.0부터 InnoDB가 기본으로 채택되면서 좀 더 가벼운 글로벌 락의 필요성이 생김.
- Xtrabackup, Enterprise Backup같은 백업 툴들의 안정적인 실행을 위해 백업락이 도임.
- 특정 세션에서 백업 락을 획득하면 모든 세션에서 테이블 스키마, 인증정보를 변경할 수 없다.
    - DB or Table등 모든 객체 생성 및 변경 삭제 불가
    - Repair Table과 Optimize Table 명령
    - 사용자 관리 및 비밀번호 변경
- 테이블의 데이터 변경은 허용됨.

******************************************왜 필요할까?******************************************

MySQL 서버의 구성은 소스서버와 레플리카 서버로 구성되는다.

백업은 레플리카 서버에서 실행된다.

백업이 FLUSH TABLES WITH READ LOCK  명령을 이용해 글로벌 락을 획득시 → 복제는 백업시간만큼 지연

백업 도중 소스 서버에 문제가 생기면 백업 시간만 큼지연되는 문제가 발생.

**정상적으로 복제는 실행되지만 백업의 실패를 막기위해 DDL 명령이 실행되면 복제를 일시 중지하는 역할을 함.**

## 테이블 락

- 개별 테이블 단위로 설정되는 잠금
- 명시적, 묵시적으로 Lock을 획득하고 해제할 수 있다.
    - LOCK TABLES table_name[READ:WRITE] 명령으로 특정 테이블 락 획득
    - 해제는 UNLOCK TABLES 이용
- 묵시적 LOCK은
    - MyISAM, MEMORY DB 는 TABLE 변경, 쿼리 실행시 발생 쿼리가 실행되는 동안 획득 끝나면 자동 해제.
    - **InnoDB 레코드 단위 잠금을 지원 스토리지 엔진 차원에서 단순 레코드 변경에 테이블락 사용하지 않음**
        - **DDL 쿼리에만 영향**

## 네임드 락

- 임의의 문자열에 대한 잠금 설정
- 잠금의 대상이 테이블이나 레코드가 아님
- MySQL8.0 부터 네임드락은 중첩이 가능하고 한번에 모두 해제하는 기능이 추가됨.

************************************어디에 사용할까?************************************

- 많은 레코드에 대해서 복잡한 요건으로 레코드를 변경하는 트랜잭션에 유용하게 사용
- 배치 프로그램 처럼 한꺼번에 많은 레코드를 변경하는 경우 → 데드락 원인
    - 동일데이터를 변경하거나 참조하는 프로그램끼리 분류해서 Named Lock을 걸고 쿼리를 실행하는 방법으로 해결할 수 있다.

## 메타데이터 락

- DB의 객체( 테이블, 뷰)의 이름이나 구조를 변경하는 경우에 획득하는 잠금
- 명시적으로 획든하는 것은 아니다.
- 테이블 이름을 변경하는 경우에 자동으로 획득

## InnoDB 스토리지 엔진 잠금

- MySQL에서 제공하는 잠금과 별개로 스토리지 엔진 내부에서 레코드 기반의 잠금 방식 채택
- 레코드 기반 잠금 방식 덕분에 MyISAM 보다 훨씬 뛰어난 동시성 성능을 가짐.
- 잠금 정보가 상당히 작은 공간으로 관리되기 때문에 레코드락이 페이지락으로, 또는 테이블 락으로 레벨업 되는 경우(락 에스컬레이션)은 없다.
- InnoDB에는 갭(GAP) 락 이라는 것이 존재

**InnoDB의 잠금 정보를 진단할 수 있는 방법은 상당히 어려웠지만 최근에 조회할 수 있는 방법이 도입**

- MySQL 서버에 information_schema 데이터베이스에 존재하는 INNODB_TRX, INNODB_LOCKS, INNODB_LOCK_WAITS라는 테이블을 조인해 LOCK을 조회하고 대기, 어느 트랜잭션이 소유하고 있는지 , 장시간 잠금을 소유하고 있는 클라이언트 등을 확인할 수 있다.

![image](https://github.com/yssy3135/TIL/assets/62733005/657c4d05-8370-425b-9884-3907b707aa86)

