## 먼저 N+1 문제란 무었일까?

조회된 엔티티가 가지고 있는 ToMany, ToOne 으로 매핑된 자식 엔티티들의 쿼리가 추가로 수행되는 현상이다.

N+1 문제를 해결하기 위해 여러 방법이 있다.

- Fetch Join으로 해결하는 방법
- batch size 설정을 통해 in절로 조회도록 하는 방법

대부분의 경우에는 해결이 되지만 해결이 되지 않는 경우가 있다.

## 여러개의 toMany로 매핑된 엔티티를 fetch join 할때 MultiBagException를 고려해야 한다!

**언제 발생할까?**

말 그대로 여러개의 toMany로 매핑된 엔티티를 fetch join 하려고 할 때 발생한다.

**왜 발생할까?**

- Hibernate에서는 Bag이라는 컬렉션을 사용한다.
- **이 Bag은 Set처럼 순서가 없고 List 처럼 중복이 허용된다**
- **Java Collection에서는 Bag이 존재하지 않아 List를 Bag 처럼 사용한다.**
- 이 때, 엔티티에서 두개의 Bag을 가져오게 되면 데카르트 발생할 수 있다.
- Bag에는 순서가 없기 때문에 Hibernate에서는 중복이 발생할수 있고 올바르게 엔티티에 매핑 할 수 없는 것.

### 그럼 어떻게 해결해야 할까?

일단 List 형식의 두개의 ToMany로 매핑된 자식 엔티티는 fetch 할 수 없다 그러므로

- 순서나 중복이 필요 없는경우 Set으로 변경 한다.
    - Set은 하이버네이트에서 SetType으로 취급하기 때문에 Bag 유형이 하나만 존재하는 경우에는 동시에 컬렉션을 가져올 수 있다.
- 가장 많은 정보를 가진 엔티티를 fetch join으로 조회하고 나머지를 batch size설정을 통해 in절로 조회되도록 구성한다.